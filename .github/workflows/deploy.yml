name: Deploy to VPS

on:
  push:
    branches: ["prod"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set image tag
        id: meta
        run: echo "tag=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Build runner com cache (app)
      - name: Build nexus-os (runner) with cache
        uses: docker/build-push-action@v5
        id: runner
        with:
          context: .
          file: ./Dockerfile
          target: runner
          # N찾o push, s처 build local
          outputs: type=docker
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            DATABASE_URL=dummy

      # Build builder com cache (migrate)
      - name: Build nexus-os-migrate (builder) with cache
        uses: docker/build-push-action@v5
        id: migrate
        with:
          context: .
          file: ./Dockerfile
          target: builder
          # N찾o push, s처 build local
          outputs: type=docker
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            DATABASE_URL=dummy

      - name: Save Docker images to tarball
        run: |
          TAG=${{ steps.meta.outputs.tag }}
          docker save nexus-os:${TAG} nexus-os-migrate:${TAG} | gzip > nexus-images.tar.gz
          echo "Tamanho do tarball: $(ls -lh nexus-images.tar.gz | cut -d' ' -f5)"
          echo "TAR_SIZE=$(du -b nexus-images.tar.gz | cut -f1)" >> $GITHUB_OUTPUT

      - name: Upload image tarball to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          source: "nexus-images.tar.gz"
          target: "/opt/nexus-os/nexus-images.tar.gz"
          rm: true
          overwrite: true
          timeout: 60s
          command_timeout: 600s  # 10min para upload

      - name: Upload docker-compose.yml to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          source: "docker-compose.yml"
          target: "/opt/nexus-os/docker-compose.yml"
          rm: false
          overwrite: true
          timeout: 60s
          command_timeout: 60s

      - name: Configure and deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        env:
          PROD_ENV_FILE: ${{ secrets.PROD_ENV_FILE }}
          IMAGE_TAG: ${{ steps.meta.outputs.tag }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          envs: PROD_ENV_FILE,IMAGE_TAG
          script_stop: true
          timeout: 300s
          script: |
            set -e
            cd /opt/nexus-os

            printf "%s" "$PROD_ENV_FILE" > .env
            echo "IMAGE_TAG=${IMAGE_TAG}" >> .env

            echo "Carregando imagens..."
            gunzip -c nexus-images.tar.gz | docker load

            echo "Deploy..."
            docker compose down || true
            docker compose up -d
            docker compose ps
