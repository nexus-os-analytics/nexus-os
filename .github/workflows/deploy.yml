name: Deploy to VPS

on:
  push:
    branches: ["prod"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: [self-hosted, Linux, X64]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set image tag
        id: meta
        run: echo "tag=$(echo $GITHUB_SHA | cut -c1-8)" >> $GITHUB_OUTPUT

      - name: Prepare files for upload
        run: |
          git clean -fdx
          rm -rf node_modules .git .next
          echo "ğŸ“¦ Upload pronto: $(du -sh .)"

      - name: Upload project to VPS (RAW)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          source: "./"
          target: "/opt/nexus-os"
          rm: true
          strip_components: 0
          overwrite: true
          timeout: 120s
          command_timeout: 300s

      - name: Configure and deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        env:
          PROD_ENV_FILE: ${{ secrets.PROD_ENV_FILE }}
          IMAGE_TAG: ${{ steps.meta.outputs.tag }}  # â† ADICIONADO
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          envs: PROD_ENV_FILE,IMAGE_TAG  # â† ADICIONADO
          script_stop: true
          timeout: 600s
          script: |
            set -e
            cd /opt/nexus-os

            ls -la
            echo "Dockerfile: $(test -f Dockerfile && echo âœ… || echo âŒ)"
            echo "docker-compose.yml: $(test -f docker-compose.yml && echo âœ… || echo âŒ)"
            echo "IMAGE_TAG=${IMAGE_TAG:-undefined}"  # â† DEBUG

            printf "%s" "$PROD_ENV_FILE" > .env
            echo "IMAGE_TAG=${IMAGE_TAG}" >> .env  # â† GRAVA NO .env
            # Export IMAGE_TAG so Compose can substitute immediately even if .env isn't parsed
            export IMAGE_TAG="${IMAGE_TAG}"
            echo "Using IMAGE_TAG=${IMAGE_TAG}"

            echo "ğŸ›‘ Parando..."
            docker compose down || true

            echo "ğŸ”¨ Build + up..."
            docker compose build --pull
            docker compose up -d

            echo "ğŸ“Š Status:"
            docker compose ps
