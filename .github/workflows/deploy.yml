name: Deploy to VPS

on:
  push:
    branches: ["prod"]
  workflow_dispatch:

jobs:
  deploy:
    # Tags do seu self-hosted runner
    runs-on: [self-hosted, Linux, X64]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch mais commits pro docker cache funcionar na VPS
          fetch-depth: 0

      - name: Prepare files for upload (git clean)
        run: |
          # Remove arquivos desnecessÃ¡rios pro upload (node_modules, .git, etc.)
          git clean -fdx
          rm -rf node_modules .git
          echo "ðŸ“¦ Arquivos prontos para upload: $(du -sh .)"

      - name: Upload project to VPS (RAW)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          source: "./"
          target: "/opt/nexus-os"
          rm: true
          strip_components: 0
          overwrite: true
          timeout: 120s
          command_timeout: 300s  # Mais tempo pro upload

      - name: Configure and deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        env:
          PROD_ENV_FILE: ${{ secrets.PROD_ENV_FILE }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          envs: PROD_ENV_FILE
          script_stop: true
          timeout: 600s  # Tempo pra build na VPS
          script: |
            set -e
            cd /opt/nexus-os

            # Debug upload
            ls -la
            echo "Dockerfile existe? $(test -f Dockerfile && echo âœ… || echo âŒ)"
            echo "docker-compose.yml existe? $(test -f docker-compose.yml && echo âœ… || echo âŒ)"

            # Cria .env
            printf "%s" "$PROD_ENV_FILE" > .env
            if [ ! -s .env ]; then
              echo "âŒ .env vazio" >&2
              exit 1
            fi
            echo "âœ… .env: $(wc -l < .env) linhas"

            # Para containers antigos
            echo "ðŸ›‘ Parando containers..."
            docker compose down || true

            # Build + deploy com cache e pull
            echo "ðŸ”¨ Build + up..."
            docker compose build --pull --no-cache=false  # Cache ativado
            docker compose up -d

            # Status final
            echo "ðŸ“Š Status:"
            docker compose ps
            docker compose logs --tail=20 app || true
