name: Deploy to VPS

on:
  push:
    branches: ["prod"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: [self-hosted, Linux, X64]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set image tag
        id: meta
        run: echo "tag=$(echo $GITHUB_SHA | cut -c1-8)" >> $GITHUB_OUTPUT

      - name: Create .env
        run: |
          printf "%s\n" "${{ secrets.PROD_ENV_FILE }}" > .env
          echo "IMAGE_TAG=${{ steps.meta.outputs.tag }}" >> .env
          echo "âœ… .env criado:"
          wc -l .env || true
          head -n 5 .env || true

      - name: Prepare files for upload
        run: |
          git clean -fdx -e .env
          rm -rf node_modules .git .next
          echo "ðŸ“¦ Upload: $(du -sh .)"

      - name: Upload .env FIRST
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          source: ".env"
          target: "/opt/nexus-os/.env"
          rm: true
          overwrite: true

      - name: Upload project to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          source: "./"
          target: "/opt/nexus-os"
          rm: true
          strip_components: 0
          overwrite: true
          timeout: 120s
          command_timeout: 300s

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script_stop: true
          timeout: 600s
          script: |
            set -e
            cd /opt/nexus-os

            # Debug
            ls -la .env*
            echo "IMAGE_TAG from .env: $(grep IMAGE_TAG .env || echo 'not found')"

            echo "ðŸ›‘ Cleanup..."
            docker compose down || true
            docker compose rm -f

            echo "ðŸ”¨ Building images (migrate, app)..."
            docker compose --env-file .env build --pull migrate app
            echo "ðŸ”Ž Built images:"
            docker images | grep nexus-os-migrate || true
            docker images | grep nexus-os || true

            echo "ðŸš€ Build + deploy..."
            docker compose --env-file .env up -d --build --force-recreate --remove-orphans

            sleep 15  # Next.js startup
            echo "ðŸ“Š Status:"
            docker compose ps
            docker compose logs --tail=20 app traefik
