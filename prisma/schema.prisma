generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// User and Authentication Models

enum PlanTier {
  FREE
  PRO
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  USER
  GUEST
}

model User {
  id                   String             @id @default(uuid())
  name                 String
  email                String             @unique
  hashedPassword       String? // Torne opcional para usu√°rios OAuth
  role                 UserRole           @default(USER)
  image                String?
  phone                String?
  acceptedTerms        Boolean            @default(false)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  deletedAt            DateTime?
  retentionUntil       DateTime?
  twoFactorSecret      String?
  resetToken           String?
  resetTokenExpiry     DateTime?
  isTwoFactorEnabled   Boolean            @default(false)
  failedAttempts       Int                @default(0)
  onboardingCompleted  Boolean            @default(false)
  lockedUntil          DateTime?
  emailVerified        DateTime? // Adicionado para NextAuth
  // Billing & subscriptions
  planTier             PlanTier           @default(FREE)
  stripeCustomerId     String?
  stripeSubscriptionId String?
  subscriptionStatus   String?
  currentPeriodEnd     DateTime?
  trialEnd             DateTime?
  accounts             Account[] // Adicionado para NextAuth
  sessions             Session[] // Adicionado para NextAuth
  loginActivities      LoginActivity[]
  auditLogs            AuditLog[]
  apiKeys              ApiKey[]
  securityIncidents    SecurityIncident[]
  blingIntegration     BlingIntegration?
  blingSyncStatus      BlingSyncStatus    @default(IDLE)
  invitationsSent      UserInvitation[]

  @@index([email, createdAt, deletedAt])
  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String // "oauth" | "email" | "credentials"
  provider          String // "google", "github", etc.
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model UserInvitation {
  id              String    @id @default(uuid())
  email           String
  token           String    @unique
  role            UserRole  @default(USER)
  invitedByUserId String
  expiresAt       DateTime
  consumedAt      DateTime?
  createdAt       DateTime  @default(now())
  invitedBy       User      @relation(fields: [invitedByUserId], references: [id], onDelete: Cascade)

  @@index([email, token, expiresAt, consumedAt])
  @@map("user_invitations")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model AuditLog {
  id        String   @id @default(uuid())
  user      User?    @relation(fields: [userId], references: [id])
  userId    String?
  action    String
  resource  String
  payload   Json?
  metadata  String?
  createdAt DateTime @default(now())

  @@index([userId, createdAt])
  @@map("audit_logs")
}

model SecurityIncident {
  id        String   @id @default(uuid())
  user      User?    @relation(fields: [userId], references: [id])
  userId    String?
  type      String
  details   String
  createdAt DateTime @default(now())

  @@index([userId, createdAt])
  @@map("security_incidents")
}

model LoginActivity {
  id         String   @id @default(uuid())
  user       User     @relation(fields: [userId], references: [id])
  userId     String
  successful Boolean
  ip         String
  device     String?
  geo        String?
  createdAt  DateTime @default(now())

  @@index([userId, createdAt])
  @@map("login_activities")
}

model ApiKey {
  id        String    @id @default(uuid())
  user      User      @relation(fields: [userId], references: [id])
  userId    String
  key       String    @unique
  scopes    String[]
  expiresAt DateTime?
  createdAt DateTime  @default(now())
  revoked   Boolean   @default(false)

  @@index([key, userId, createdAt])
  @@map("api_keys")
}

model DataRegistry {
  id        String   @id @default(uuid())
  location  String
  type      String
  createdAt DateTime @default(now())

  @@index([createdAt])
  @@map("data_registries")
}

// Bling Integration Models

enum BlingAlertType {
  FINE
  RUPTURE
  DEAD_STOCK
  OPPORTUNITY
  LIQUIDATION
}

enum BlingRuptureRisk {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum BlingSyncStatus {
  IDLE
  SYNCING
  COMPLETED
  FAILED
}

enum BlingJobSyncType {
  SALES
  FULL
}

enum BlingJobStatus {
  RUNNING
  FAILED
  DONE
}

model BlingIntegration {
  id           String         @id @default(uuid())
  userId       String         @unique
  accessToken  String         @db.Text
  refreshToken String         @db.Text
  expiresAt    DateTime
  tokenType    String
  scope        String
  connectedAt  DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  products     BlingProduct[]

  @@map("bling_integrations")
}

model BlingProduct {
  id               String                @id @default(uuid())
  blingProductId   String                @unique
  blingCategoryId  String?
  name             String
  sku              String
  costPrice        Float                 @default(0)
  salePrice        Float                 @default(0)
  currentStock     Int                   @default(0)
  image            String?               @db.Text
  shortDescription String?               @db.Text
  integrationId    String
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  integration      BlingIntegration      @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  category         BlingCategory?        @relation(fields: [blingCategoryId], references: [blingCategoryId], onDelete: SetNull)
  alert            BlingAlert?
  settings         BlingProductSettings?
  salesHistory     BlingSalesHistory[]
  stockBalances    BlingStockBalance[]

  @@index([blingProductId, integrationId])
  @@map("bling_products")
}

model BlingProductSettings {
  id                                String       @id @default(uuid())
  blingProductId                    String       @unique
  leadTimeDays                      Int          @default(15)
  safetyDays                        Int          @default(5)
  criticalDaysRemainingThreshold    Int          @default(7)
  highDaysRemainingThreshold        Int          @default(15)
  mediumDaysRemainingThreshold      Int          @default(30)
  opportunityGrowthThresholdPct     Float        @default(0.5)
  opportunityDemandVvd              Float        @default(1)
  deadStockCapitalThreshold         Float        @default(5000)
  capitalOptimizationThreshold      Float        @default(10000)
  ruptureCapitalThreshold           Float        @default(5000)
  liquidationDiscount               Float        @default(0.3)
  costFactor                        Float        @default(0.8)
  liquidationExcessCapitalThreshold Float        @default(2000)
  fineExcessCapitalMax              Float        @default(5000)
  product                           BlingProduct @relation(fields: [blingProductId], references: [blingProductId], onDelete: Cascade)

  @@map("bling_product_settings")
}

model BlingCategory {
  id              String         @id @default(uuid())
  name            String
  blingCategoryId String         @unique
  blingParentId   String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  products        BlingProduct[]

  @@map("bling_categories")
}

model BlingSalesHistory {
  id             String       @id @default(uuid())
  blingSaleId    String
  blingProductId String
  date           DateTime
  quantity       Int          @default(0)
  totalValue     Float        @default(0)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  product        BlingProduct @relation(fields: [blingProductId], references: [blingProductId], onDelete: Cascade)

  @@unique([blingSaleId, blingProductId])
  @@index([blingProductId, blingSaleId, date])
  @@map("bling_sales_history")
}

model BlingStockBalance {
  id             String       @id @default(uuid())
  blingProductId String
  stock          Int          @default(0)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  product        BlingProduct @relation(fields: [blingProductId], references: [blingProductId], onDelete: Cascade)

  @@index([blingProductId])
  @@map("bling_stock_balance")
}

model BlingAlert {
  id                     String           @id @default(uuid())
  blingProductId         String           @unique
  type                   BlingAlertType   @default(FINE)
  risk                   BlingRuptureRisk @default(LOW)
  vvdReal                Float            @default(0)
  vvd30                  Float            @default(0)
  vvd7                   Float            @default(0)
  daysRemaining          Int              @default(0)
  reorderPoint           Int              @default(0)
  growthTrend            Float            @default(0)
  capitalStuck           Float            @default(0)
  daysSinceLastSale      Int              @default(0)
  suggestedPrice         Float            @default(0)
  discount               Int              @default(0)
  discountAmount         Float            @default(0)
  estimatedDeadline      Int              @default(0)
  recoverableAmount      Float            @default(0)
  daysOutOfStock         Int              @default(0)
  estimatedLostSales     Int              @default(0)
  estimatedLostAmount    Int              @default(0)
  // New excess/cover metrics
  idealStock             Float            @default(0)
  excessUnits            Int              @default(0)
  excessPercentage       Float            @default(0)
  excessCapital          Float            @default(0)
  message                String?          @db.Text
  recommendations        Json?
  lastCriticalNotifiedAt DateTime?
  createdAt              DateTime         @default(now())
  updatedAt              DateTime         @updatedAt
  jobId                  String?
  product                BlingProduct     @relation(fields: [blingProductId], references: [blingProductId], onDelete: Cascade)

  @@index([blingProductId, type, risk])
  @@map("bling_alerts")
}

model BlingSyncJob {
  id               String           @id @default(uuid())
  integrationId    String
  userId           String
  type             BlingJobSyncType
  totalBatches     Int
  processedBatches Int              @default(0)
  status           BlingJobStatus   @default(RUNNING)
  startedAt        DateTime         @default(now())
  finishedAt       DateTime?
  metadata         Json?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  @@index([integrationId, status, createdAt])
  @@map("bling_sync_jobs")
}
